var imagoControls,imagoControlsController;imagoControls=function(){function e(){return{replace:!0,require:"^imagoVideo",templateUrl:"/imago/controlsVideo.html",controller:"imagoControlsController",controllerAs:"imagocontrols",link:function(e,o,i){return e.seek=function(o){return e.imagovideo.player.currentTime=o},e.onVolumeChange=function(o){return function(o){return e.imagovideo.player.volume=parseFloat(o/100)}}(this),e.volumeDown=function(o){return function(){return e.imagovideo.player.volume=0,e.volumeInput=0}}(this),e.volumeUp=function(o){return function(){return e.imagovideo.player.volume=1,e.volumeInput=100}}(this),e.fullScreen=function(o){return function(){return e.imagovideo.player.requestFullscreen?e.imagovideo.player.requestFullscreen():e.imagovideo.player.webkitRequestFullscreen?e.imagovideo.player.webkitRequestFullscreen():e.imagovideo.player.mozRequestFullScreen?e.imagovideo.player.mozRequestFullScreen():e.imagovideo.player.msRequestFullscreen?e.imagovideo.player.msRequestFullscreen():void 0}}(this),o.bind("mouseup",function(e){return e.stopPropagation()}),o.bind("mousedown",function(e){return e.stopPropagation()})}}}return e}(),imagoControlsController=function(){function e(e){var o;o=angular.element(e.imagovideo.player),e.currentTime=0,o.bind("loadeddata",function(o){return e.duration=parseInt(o.target.duration),e.$digest()}),o.bind("timeupdate",function(o){return e.currentTime=o.target.currentTime,e.$digest()}),o.bind("seeking",function(o){return e.currentTime=o.target.currentTime,e.$digest()})}return e}(),angular.module("imago").directive("imagoControls",[imagoControls]).controller("imagoControlsController",["$scope",imagoControlsController]);var imagoVideo,imagoVideoController;imagoVideo=function(){function e(e,o,i){return{replace:!0,scope:{visible:"=",source:"=imagoVideo"},templateUrl:"/imago/imagoVideo.html",controllerAs:"imagovideo",controller:"imagoVideoController",link:function(t,n,r){var a,l,s,u,c,d,p,g,m,v,f,h,y;g={},c={autobuffer:null,autoplay:!1,controls:!0,preload:"none",size:"hd",align:"center center",sizemode:"fit",lazy:!0,hires:!0,loop:!1,width:"",height:""};for(l in r)h=r[l],c[l]="true"===h||"false"===h?JSON.parse(h):"width"===l||"height"===l?"auto"===h?h:parseInt(h):h;return g.watch=t.$watch("source",function(e){return function(e){var o,i,a;if(e)return r.watch||g.watch(),(null!=(o=t.source.fields)&&null!=(i=o.formats)?i.length:void 0)?(null!=(a=t.source)?a.serving_url:void 0)?(t.source.fields.hasOwnProperty("crop")&&!r.align&&(c.align=t.source.fields.crop.value),t.source.fields.hasOwnProperty("sizemode")&&("default"===t.source.fields.sizemode.value||r.sizemode||(c.sizemode=t.source.fields.sizemode.value)),d()):void n.remove():console.log("no formats found")}}(this)),d=function(){var e,o,i,r,a,l,u;return angular.isString(t.source.resolution)&&(i=t.source.resolution.split("x"),r={width:i[0],height:i[1]},c.assetRatio=i[0]/i[1]),t.controls=c.controls,c.width&&c.height?(u=c.width,o=c.height):(u=n[0].clientWidth,o=n[0].clientHeight),e=c.hires?Math.ceil(window.devicePixelRatio)||1:1,a=t.source.serving_url+"=s"+(Math.ceil(Math.min(Math.max(u,o)*e))||1600),l={size:c.size,sizemode:c.sizemode,backgroundPosition:c.align,backgroundImage:"url("+a+")",backgroundRepeat:"no-repeat"},t.wrapperStyle=l,m(),t.videoFormats=s(),p(u,o,a)},m=function(){return c.autoplay===!0&&t.imagovideo.player.setAttribute("autoplay",!0),t.imagovideo.player.setAttribute("preload",c.preload),t.imagovideo.player.setAttribute("x-webkit-airplay","allow"),t.imagovideo.player.setAttribute("webkitAllowFullscreen",!0),c.loop===!0?t.imagovideo.player.setAttribute("loop",c.loop):void 0},p=function(e){return function(e,o,i){var n;return c.lazy&&!t.visible?g.visibleFunc=t.$watch("visible",function(t){return t?(g.visibleFunc(),p(e,o,i)):void 0}):(n=angular.element("<img>"),n.on("load",function(i){return _.assign(t.wrapperStyle,f(e,o)),t.videoStyle=v(e,o),t.loading=!1,t.$apply()}),n[0].src=i)}}(this),f=function(e,o){var i,t;if(e&&o)return i={},t=e/o,"crop"===c.sizemode?i.backgroundSize=c.assetRatio<t?"100% auto":"auto 100%":c.assetRatio<t?(i.width=Math.round(o*c.assetRatio)+"px",i.height=o+"px",i.backgroundSize="auto 100%"):(i.width=e+"px",i.height=Math.round(e/c.assetRatio)+"px",i.backgroundSize="100% auto"),i},v=function(e){return function(e,o){var t,n;if(e&&o)return t={},n=e/o,i.isiOS()?(t.width="100%",t.height="100%","center center"===c.align&&"crop"===c.sizemode&&(t.top="0",t.left="0")):"crop"===c.sizemode?c.assetRatio<n?(t.width="100%",t.height="auto","center center"===c.align&&(t.top="50%",t.left="auto",t.marginTop="-"+Math.round(o/2)+"px",t.marginLeft="0px")):(t.width="auto",t.height="100%","center center"===c.align&&(t.top="auto",t.left="50%",t.marginTop="0px",t.marginLeft="-"+Math.round(e/2)+"px")):c.assetRatio<n?(t.width="auto",t.height="100%"):(t.width="100%",t.height="auto"),t}}(this),s=function(){var e,o,i,n,r,l,s,u;for(i=[],e=a(),t.source.fields.formats.sort(function(e,o){return o.height-e.height}),n="online"===data?"api.imago.io":"localhost:8000",u=t.source.fields.formats,r=l=0,s=u.length;s>l;r=++l)o=u[r],e===o.codec&&i.push({src:"//"+n+"/api/play_redirect?uuid="+t.source.uuid+"&codec="+o.codec+"&quality=hd&max_size="+o.size,size:o.size,codec:o.codec,type:"video/"+e});return i},a=function(){var e;if(t.imagovideo.player.canPlayType){e={mp4:'video/mp4; codecs="mp4v.20.8"',mp4:'video/mp4; codecs="avc1.42E01E"',mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',webm:'video/webm; codecs="vp8, vorbis"',ogg:'video/ogg; codecs="theora"'};for(l in e)if(h=e[l],t.imagovideo.player.canPlayType(h))return l}},t.toggleSize=function(){return"hd"===c.size?(c.size="sd",t.wrapperStyle.size="sd"):(c.size="hd",t.wrapperStyle.size="hd"),t.videoFormats.reverse(),e(function(){return t.imagovideo.player.load(),t.imagovideo.player.play()})},u=function(){var e,o;return o=n[0].clientWidth||c.width,e=n[0].clientHeight||c.height,_.assign(t.wrapperStyle,f(o,e)),t.videoStyle=v(o,e),t.$apply()},y={},y.resize=o.$on("resize",u),y.resizestop=o.$on("resizestop",function(){return d(t.source)}),t.$on("$destroy",function(){var e;e=[];for(l in y)e.push(y[l]());return e}),t.$on("$stateChangeSuccess",function(){return e(function(){var e;return document.createEvent?(e=new Event("checkInView"),window.dispatchEvent(e)):(e=document.createEventObject(),e.eventType="checkInView",e.eventName="checkInView",window.fireEvent("on"+e.eventType,e))})})}}}return e}(),imagoVideoController=function(){function e(e,o,i){this.player=o.find("video")[0],e.loading=!0,angular.element(this.player).bind("ended",function(e){return function(o){return e.player.currentTime=0,e.state="end"}}(this)),angular.element(this.player).bind("loadeddata",function(o){return function(){return e.hasPlayed=!0,angular.element(o.player).unbind("loadeddata")}}(this)),angular.element(this.player).bind("play",function(e){return function(){return e.state="playing"}}(this))}var o;return o=function(){return e.player.paused?(e.state="playing",e.player.play()):(e.state="paused",e.player.pause())},e}(),angular.module("imago").directive("imagoVideo",["$timeout","$rootScope","imagoUtils",imagoVideo]).controller("imagoVideoController",["$scope","$element","$attrs",imagoVideoController]);var Time;Time=function(){function e(){return function(e){var o,i,t,n,r;if("number"==typeof e)return n=function(e){return 10>e?"0"+e:e},o=[],t=Math.floor(e/60),i=Math.floor(e/3600),r=0===e?0:e%60,r=Math.round(r),i>0&&o.push(n(i)),o.push(n(t)),o.push(n(r)),o.join(":")}}return e}(),angular.module("imago").filter("time",[Time]),angular.module("imago").run(["$templateCache",function(e){e.put("/imago/controlsVideo.html",'<div stop-propagation="stop-propagation" class="controls"><a ng-click="imagovideo.togglePlay()" ng-class="{\'fa-pause\': imagovideo.state === \'playing\', \'fa-play\': imagovideo.state === \'paused\'}" class="video-play fa fa-play"></a><span class="video-time">{{currentTime | time}}</span><span class="video-seekbar"><input type="range" ng-model="currentTime" min="0" max="{{duration}}" ng-change="seek(currentTime)" class="seek"/></span><a ng-click="toggleSize()" class="size">{{wrapperStyle.size}}</a><span class="volume"><span ng-click="volumeUp()" class="fa fa-volume-up icon-volume-up"></span><input type="range" ng-model="volumeInput" ng-change="onVolumeChange(volumeInput)"/><span ng-click="volumeDown()" class="fa fa-volume-down icon-volume-down"></span></span><a ng-click="fullScreen()" class="video-fullscreen fa fa-expand"></a><a class="video-screen fa fa-compress"></a></div>'),e.put("/imago/imagoVideo.html",'<div ng-class="{loading: loading}" in-view="visible = $inview" visible="visible" responsive-events="responsive-events" class="imagovideo {{wrapperStyle.backgroundPosition}} {{wrapperStyle.size}} {{wrapperStyle.sizemode}}"><div ng-style="wrapperStyle" ng-class="imagovideo.state" class="imagowrapper"><a ng-hide="loading" ng-click="imagovideo.togglePlay()" ng-class="{playing: imagovideo.isPlaying}" stop-propagation="stop-propagation" class="playbig fa fa-play"></a><video ng-style="videoStyle"><source ng-repeat="format in videoFormats" src="{{format.src}}" data-size="{{format.size}}" data-codec="{{format.codec}}" type="{{format.type}}"/></video><div imago-controls="imago-controls" ng-style="controlStyle" ng-show="controls &amp;&amp; hasPlayed"></div></div></div>')}]);
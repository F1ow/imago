var FulfillmentsCenter,indexOf=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1};FulfillmentsCenter=function(){function t(t,i,e,o,n){this.$http=t,this.$rootScope=i,this.geoIp=e,this.imagoSettings=o,this.imagoUtils=n,this.get()}return t.prototype.data=[],t.prototype.selected={},t.prototype.get=function(){return this.$http.get(this.imagoSettings.host+"/api/fulfillmentcenters").then(function(t){return function(i){return t.data=i.data,t.getOptions()}}(this))},t.prototype.getOptions=function(){var t;return 1===this.data.length?(this.selected=this.data[0],this.$rootScope.$emit("fulfillments:loaded",this.data)):this.geoIp.data.country?this.geoValid():null===this.geoIp.data?this.getGeneric():_.isEmpty(this.geoIp.data)?t=this.$rootScope.$on("geoip:loaded",function(i){return function(e,o){return t(),i.geoIp.data.country?i.geoValid():i.getGeneric()}}(this)):void 0},t.prototype.getGeneric=function(){return this.selected=_.find(this.data,function(t){return!t.countries.length}),this.$rootScope.$emit("fulfillments:loaded",this.data)},t.prototype.geoValid=function(){return this.selected=_.find(this.data,function(t){return function(i){var e;return e=t.geoIp.data.country,indexOf.call(i.countries,e)>=0}}(this)),this.selected?this.$rootScope.$emit("fulfillments:loaded",this.data):this.getGeneric()},t}(),angular.module("imago").service("fulfillmentsCenter",["$http","$rootScope","geoIp","imagoSettings","imagoUtils",FulfillmentsCenter]);var GeoIp;GeoIp=function(){function t(t,i,e){this.$rootScope=t,this.$http=i,this.imagoUtils=e,this.get()}return t.prototype.data={},t.prototype.get=function(){return this.imagoUtils.cookie("countryGeo")?(this.data.country=this.imagoUtils.cookie("countryGeo"),void this.$rootScope.$emit("geoip:loaded",this.data)):this.$http.get("//api.imago.io/geoip").then(function(t){return function(i){return t.data=i.data,t.imagoUtils.cookie("countryGeo",t.data.country),t.$rootScope.$emit("geoip:loaded",t.data)}}(this),function(t){return function(i){return t.data=null,t.$rootScope.$emit("geoip:loaded",t.data)}}(this))},t}(),angular.module("imago").service("geoIp",["$rootScope","$http","imagoUtils",GeoIp]);var imagoCart,imagoCartController;imagoCart=function(){function t(){return{replace:!0,scope:{min:"=",max:"=",ngModel:"="},transclude:!0,templateUrl:"/imago/imago-cart.html",controller:"imagoCartController as cart"}}return t}(),imagoCartController=function(){function t(t){this.imagoCart=t,this.clickOut=function(t,i){return"BUTTON"!==t.target.tagName||-1===t.target.className.indexOf(i)?this.imagoCart.show=!1:void 0}}return t}(),angular.module("imago").directive("imagoCart",[imagoCart]).controller("imagoCartController",["imagoCart",imagoCartController]);var imagoCart,bind=function(t,i){return function(){return t.apply(i,arguments)}},indexOf=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1};imagoCart=function(){function t(t,i,e,o,n,r,a,s,c){this.$q=t,this.$rootScope=i,this.$window=e,this.$http=o,this.imagoUtils=n,this.imagoModel=r,this.fulfillmentsCenter=a,this.geoIp=s,this.imagoSettings=c,this.remove=bind(this.remove,this),this.update=bind(this.update,this),this.create=bind(this.create,this),this.checkCart=bind(this.checkCart,this),this.checkStatus=bind(this.checkStatus,this),this.cart={items:[]},this.$rootScope.$on("settings:loaded",function(t){return function(i,e){var o;return t.currencies=t.$rootScope.tenantSettings.currencies,o=t.imagoUtils.cookie("imagoCart"),o?t.checkStatus(o):(1===t.currencies.length&&(t.currency=t.currencies[0]),t.checkGeoIp())}}(this))}return t.prototype.show=!1,t.prototype.itemsLength=0,t.prototype.settings=[],t.prototype.checkGeoIp=function(){var t;return null===this.geoIp.data?this.checkCurrency():_.isEmpty(this.geoIp.data)?t=this.$rootScope.$on("geoip:loaded",function(i){return function(e,o){return i.geo=i.geoIp.data,i.checkCurrency(),t()}}(this)):(this.geo=this.geoIp.data,this.checkCurrency())},t.prototype.checkCurrency=function(){var t,i;return this.geo&&(t=this.imagoUtils.CURRENCY_MAPPING[this.geo.country]),t&&this.currencies&&indexOf.call(this.currencies,t)>=0?this.currency=t:(null!=(i=this.currencies)?i.length:void 0)?this.currency=this.currencies[0]:console.log("you need to enable at least one currency in the settings"),this.cart?(this.cart.currency!==this.currency&&(this.cart.currency=angular.copy(this.currency),this.update()),this.calculate()):void 0},t.prototype.checkStatus=function(t){return this.$http.get(this.imagoSettings.host+"/api/carts?cartid="+t).then(function(t){return function(i){var e;return console.log("check cart",i.data),_.assign(t.cart,i.data),t.fulfillmentsCenter.data.length?t.statusLoaded():e=t.$rootScope.$on("fulfillments:loaded",function(i,o){return t.statusLoaded(),e()})}}(this))},t.prototype.statusLoaded=function(){var t,i,e,o,n,r,a,s,c;for(o=this.cart.items,t=0,e=o.length;e>t;t++)i=o[t],i.finalsale=null!=(n=i.fields)&&null!=(r=n["final-sale"])?r.value:void 0,i.stock=Number(null!=(a=i.fields)&&null!=(s=a.stock)&&null!=(c=s.value)?c[this.fulfillmentsCenter.selected._id]:void 0);return this.currency||(this.currency=angular.copy(this.cart.currency)),this.calculate(),this.checkGeoIp()},t.prototype.checkCart=function(){var t;return t=this.$q.defer(),this.cart._id?t.resolve("update"):this.create(this.cart).then(function(i){return function(e){return _.assign(i.cart,e.data),i.imagoUtils.cookie("imagoCart",e.data._id),t.resolve("created")}}(this)),t.promise},t.prototype.create=function(t){return this.$http.post(this.imagoSettings.host+"/api/carts",t)},t.prototype.add=function(t,i,e){var o,n,r,a,s,c,u,h,l,g,d,p;if(!t)return console.log("item required");if(!t.qty)return console.log("quantity required");if(t.finalsale=null!=(g=t.fields)&&null!=(d=g["final-sale"])?d.value:void 0,_.isArray(i)&&(null!=i?i.length:void 0))for(t.options={},a=0,c=i.length;c>a;a++)h=i[a],t.options[h]=t.fields[h];else _.isPlainObject(i)&&(t.options=i);if((null!=(p=t.options)?p.name:void 0)&&(t.name=t.options.name,delete t.options.name),l=this.imagoModel.find({_id:t.parent}))if(t.name||(t.name=l.name),t.serving_url||(t.serving_url=l.serving_url),_.isArray(e)&&e.length)for(s=0,u=e.length;u>s;s++)n=e[s],t.fields[n]=l.fields[n];else _.isPlainObject(e)&&_.assign(t.fields,l.fields);return o=angular.copy(t),r=_.find(this.cart.items,{_id:o._id}),r?(r.name||(r.name=o.name),r.qty+=o.qty,_.assign(r.options,o.options),_.assign(r.fields,o.fields)):this.cart.items.push(o),this.show=!0,this.calculate(),this.checkCart().then(function(t){return function(i){return"update"===i?t.update():void 0}}(this))},t.prototype.update=function(){return this.cart._id?this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart):void 0},t.prototype.remove=function(t){return _.remove(this.cart.items,{_id:t._id}),this.calculate(),this.update()},t.prototype.calculate=function(){var t,i,e,o,n;if(this.itemsLength=0,this.subtotal=0,!this.cart.items.length)return this.subtotal=0,void(this.itemsLength=0);for(o=this.cart.items,n=[],t=0,e=o.length;e>t;t++)i=o[t],this.itemsLength+=i.qty,i.qty&&i.fields.price.value[this.currency]&&n.push(this.subtotal+=i.qty*i.fields.price.value[this.currency]);return n},t.prototype.checkout=function(){return tenant?this.$window.location.href="https://"+tenant+".imago.io/account/checkout/"+this.cart._id:void 0},t}(),angular.module("imago").service("imagoCart",["$q","$rootScope","$window","$http","imagoUtils","imagoModel","fulfillmentsCenter","geoIp","imagoSettings",imagoCart]);var VariantsStorage;VariantsStorage=function(){function t(t,i,e,o){this.$http=t,this.$q=i,this.imagoModel=e,this.imagoSettings=o}return t.prototype.data=[],t.prototype.search=function(t){return this.$http.get(this.imagoSettings.host+"/api/variants/"+t)},t.prototype.get=function(t){var i,e,o;return o=this.$q.defer(),i=this.imagoModel.find({_id:t}),e=_.filter(this.data,{parent:t}),(null!=i?i.variants.length:void 0)===e.length?o.resolve(e):this.search(t).then(function(t){return o.resolve(t.data)}),o.promise},t}(),angular.module("imago").service("variantsStorage",["$http","$q","imagoModel","imagoSettings",VariantsStorage]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-cart.html",'<div class="cart"><div ng-click="cart.imagoCart.show = !cart.imagoCart.show" class="icon"><div ng-bind="cart.imagoCart.itemsLength" class="counter"></div></div><div ng-show="cart.imagoCart.show" class="box"><div ng-transclude="ng-transclude"></div><div ng-show="cart.imagoCart.itemsLength" class="itemnumber">{{cart.imagoCart.itemsLength}} items</div><div ng-show="cart.imagoCart.itemsLength === 0" class="noitems">cart empty</div><div ng-show="cart.imagoCart.itemsLength" class="subtotal">subtotal: {{cart.imagoCart.subtotal | price:0}}</div><button ng-show="cart.imagoCart.cart.items.length" type="submit" ng-click="cart.imagoCart.checkout()" class="checkout">checkout</button></div></div>')}]);
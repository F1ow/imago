var Calculation,__bind=function(t,i){return function(){return t.apply(i,arguments)}},__indexOf=[].indexOf||function(t){for(var i=0,s=this.length;s>i;i++)if(i in this&&this[i]===t)return i;return-1};Calculation=function(){function t(t,i,s,e,n,r,o){this.$q=t,this.$state=i,this.$http=s,this.$auth=e,this.imagoUtils=n,this.imagoSettings=r,this.orderStorage=o,this.submit=__bind(this.submit,this),this.calculate=__bind(this.calculate,this),this.calculateTotal=__bind(this.calculateTotal,this),this.getZipTax=__bind(this.getZipTax,this),this.getTaxRate=__bind(this.getTaxRate,this),this.calculateShipping=__bind(this.calculateShipping,this),this.changeShipping=__bind(this.changeShipping,this),this.findShippingRate=__bind(this.findShippingRate,this),this.getShippingRate=__bind(this.getShippingRate,this),this.setShippingRates=__bind(this.setShippingRates,this),this.setCurrency=__bind(this.setCurrency,this),this.applyCoupon=__bind(this.applyCoupon,this),this.checkCoupon=__bind(this.checkCoupon,this),this.changeAddress=__bind(this.changeAddress,this),this.deleteItem=__bind(this.deleteItem,this),this.updateCart=__bind(this.updateCart,this),this.countries=n.COUNTRIES}return t.prototype.cart=void 0,t.prototype.stripe=void 0,t.prototype.currency=void 0,t.prototype.shippingmethods=void 0,t.prototype.taxes=void 0,t.prototype.currencies=void 0,t.prototype.taxincluded=void 0,t.prototype.updateCart=function(){return this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},t.prototype.deleteItem=function(t){var i;return i=_.findIndex(this.cart.items,{id:t.id}),this.cart.items.splice(i,1),this.updateCart()},t.prototype.changeAddress=function(t,i){var s,e,n,r;return(null!=(s=this.process.form.shipping_address)?s.country:void 0)&&"country"===i?this.setCurrency(null,this.process.form.shipping_address.country):"country"===i&&this.setCurrency(null,this.process.form[t].country),this[t]||(this[t]={}),"United States of America"===(e=this.process.form[t].country)||"United States"===e||"USA"===e||"Canada"===e||"Australia"===e?(this[t].disablestates=!1,this[t].states="United States of America"===(n=this.process.form[t].country)||"United States"===n?this.imagoUtils.STATES.USA:this.imagoUtils.STATES[this.process.form[t].country.toUpperCase()]):(this[t].disablestates=!0,this[t].states=[]),this.process.form[t].country_code=this.imagoUtils.CODES[this.process.form[t].country],(null!=(r=this.process.form.shipping_address)?r.country:void 0)?(this.country=this.process.form.shipping_address.country,this.state=this.process.form.shipping_address.state,this.zip=this.process.form.shipping_address.zip):(this.country=this.process.form[t].country,this.state=this.process.form[t].state,this.zip=this.process.form[t].zip),this.calculate()},t.prototype.checkCoupon=function(t){return t?this.$http.get(this.imagoSettings.host+"/api/coupons?code="+t).then(function(t){return function(i){return 1===i.data.length?(t.coupon=i.data[0],t.couponState="valid",t.calculate()):t.couponState="invalid"}}(this)):(this.couponState="",void this.calculate())},t.prototype.applyCoupon=function(){var t,i,s;if(this.coupon)return t=this.coupon.meta,"flat"===t.type?(s=Math.min(this.costs.subtotal,t.value[this.currency]),this.costs.subtotal=this.costs.subtotal-s):"percent"===t.type?(i=Number((this.costs.subtotal*t.value/1e4).toFixed(0)),this.costs.subtotal=this.costs.subtotal-i):"free shipping"===t.type?this.costs.shipping=0:void 0},t.prototype.setCurrency=function(t,i){return i&&(t=this.imagoUtils.inUsa(i)?"USD":this.imagoUtils.CURRENCY_MAPPING[i]),this.currency=__indexOf.call(this.currencies,t)>=0?t:this.currencies[0]},t.prototype.setShippingRates=function(t){return(null!=t?t.length:void 0)?_.isPlainObject(t)?this.shippingRates=[t]:_.isArray(t)&&(this.shippingRates=t):this.shippingRates=[],this.shippingRates.length?this.shipping_options=this.shippingRates[0]:void 0},t.prototype.getShippingRate=function(){var t,i;return t=this.$q.defer(),i=this.findShippingRate(),this.setShippingRates(i),t.resolve(i),t.promise},t.prototype.findShippingRate=function(){var t,i,s;if(this.country)return("United States of America"===(s=this.country)||"United States"===s)&&(this.country="USA"),i=_.filter(this.shippingmethods,function(t){return function(i){var s,e,n;return i.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,__indexOf.call(function(){var t,e,n,r;for(n=i.countries,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.filter(i,function(t){return function(i){var s,e;return e=t.state.toUpperCase(),__indexOf.call(function(){var t,e,n,r;for(n=i.states,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0}}(this)),(null!=t?t.length:void 0)?t:t=_.filter(i,function(){return function(t){return 0===t.states.length}}(this))||_.filter(this.shippingmethods,function(t){return!t.countries.length})):i||_.filter(this.shippingmethods,function(t){return!t.countries.length})},t.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options,this.$q.defer()),this.calculateTotal()},t.prototype.calculateShipping=function(){var t;return t=this.$q.defer(),this.costs.shipping=0,this.getShippingRate().then(function(i){return function(s){return(null!=s?s.length:void 0)?(i.calcShipping(s[0],t),t.promise):t.resolve()}}(this))},t.prototype.calcShipping=function(t,i){var s,e,n,r,o,a,c,h,u,p,l,d;for(s=0,r=[],u=this.cart.items,o=0,c=u.length;c>o;o++)e=u[o],(null!=(p=e.shipping_cost)?p[this.currency]:void 0)?(null!=(l=e.shipping_cost)?l[this.currency]:void 0)&&r.push(e):s+="weight"===t.type?e.weight*e.qty:e.qty;if(0===s&&"weight"!==t.type&&!r.length)return i.resolve();for(n=_.find(t.ranges,function(t){return s<=t.to_unit&&s>=t.from_unit}),n||(n=t.ranges[t.ranges.length-1]||0),this.costs.shipping="weight"===t.type?n.price[this.currency]||0:(n.price[this.currency]||0)*s,a=0,h=r.length;h>a;a++)e=r[a],this.costs.shipping+=((null!=(d=e.shipping_cost)?d[this.currency]:void 0)||0)*e.qty;return i.resolve()},t.prototype.calculateTax=function(){var t;return t=this.$q.defer(),this.getTaxRate().then(function(i){return function(){var s,e,n,r,o,a,c,h,u;if(i.costs.tax=0,i.taxincluded)return void t.resolve();if(i.imagoUtils.includesTax(i.currency)){if(i.costs.includedTax=0,i.costs.taxRate){for(c=i.cart.items,u=[],n=0,o=c.length;o>n;n++)s=c[n],e=s.fields.price.value[i.currency]/(100+i.costs.taxRate)*s.qty,i.costs.includedTax+=Math.round(e*i.costs.taxRate),u.push(t.resolve());return u}return t.resolve()}for(h=i.cart.items,r=0,a=h.length;a>r;r++)s=h[r],i.costs.tax+=Math.round(s.fields.price.value[i.currency]*s.qty*i.costs.taxRate);return t.resolve()}}(this)),t.promise},t.prototype.getTaxRate=function(){var t,i;return t=this.$q.defer(),this.costs.taxRate=0,this.taxincluded&&t.resolve(),this.country||t.resolve(),i=this.findTaxRate(),i.autotax&&this.imagoUtils.inUsa(this.country)?this.getZipTax():(this.costs.taxRate=i.rate/100,t.resolve(),t.promise)},t.prototype.findTaxRate=function(){var t,i,s,e;return("United States of America"===(e=this.country)||"United States"===e)&&(this.country="USA"),s=_.filter(this.taxes,function(t){return function(i){var s,e,n;return i.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,__indexOf.call(function(){var t,e,n,r;for(n=i.countries,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.find(s,function(t){return function(i){var s,e;return e=t.state.toUpperCase(),__indexOf.call(function(){var t,e,n,r;for(n=i.states,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0}}(this)))?t:(i=_.filter(s,function(t){return 0===t.states.length}),(null!=i?i[0]:void 0)||{rate:0}):(null!=s?s[0]:void 0)||{rate:0}},t.prototype.getZipTax=function(){var t,i;return t=this.$q.defer(),this.zip||(null!=(i=this.zip)?i.length:void 0)>4?this.$http.get(""+this.imagoSettings.host+"/api/ziptax?zipcode="+this.zip).then(function(i){return function(s){return i.costs.taxRate=s.data.taxUse,t.resolve()}}(this)):t.resolve(),t.promise},t.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&!this.taxincluded&&(this.costs.total+=this.costs.tax),this.costs.total},t.prototype.calculate=function(){var t,i,s,e;for(this.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},e=this.cart.items,i=0,s=e.length;s>i;i++)t=e[i],this.costs.subtotal+=t.qty*t.fields.price.value[this.currency];return this.costs.total=this.costs.subtotal,this.applyCoupon(),this.$q.all([this.calculateTax(),this.calculateShipping()]).then(function(t){return function(){return t.calculateTotal()}}(this))},t.prototype.submit=function(){return this.processing?void 0:(this.processing=!0,this.process.form.items=angular.copy(this.cart.items),this.process.form.costs=angular.copy(this.costs),this.process.form.currency=angular.copy(this.currency),this.process.form.billing_address.name=angular.copy(this.process.form.card.name),this.differentshipping||(this.process.form.shipping_address=angular.copy(this.process.form.billing_address)),this.$http.post(this.imagoSettings.host+"/api/checkout",this.process.form).then(function(t){return function(i){var s,e,n,r;if(console.log("response checkout",i),t.$auth.setToken(i.data.token),200===i.data.code)for(r=i.data.message,e=0,n=r.length;n>e;e++){s=r[e],console.log("order",s),t.$state.go("order",{number:s.number});break}return t.processing=!1}}(this)))},t}(),angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoSettings","orderStorage",Calculation]);var imagoCart;imagoCart=function(){function t(t){return{replace:!0,scope:{min:"=",max:"=",ngModel:"="},transclude:!0,controllerAs:"cart",templateUrl:"/imago/imago-cart.html",controller:function(){return this.utils=t}}}return t}(),angular.module("imago").directive("imagoCart",["imagoCart",imagoCart]);var imagoCart,__bind=function(t,i){return function(){return t.apply(i,arguments)}},__indexOf=[].indexOf||function(t){for(var i=0,s=this.length;s>i;i++)if(i in this&&this[i]===t)return i;return-1};imagoCart=function(){function t(t,i,s,e,n,r){var o;this.$q=t,this.$window=i,this.$http=s,this.imagoUtils=e,this.imagoModel=n,this.imagoSettings=r,this.remove=__bind(this.remove,this),this.update=__bind(this.update,this),this.add=__bind(this.add,this),this.create=__bind(this.create,this),this.checkCart=__bind(this.checkCart,this),this.checkStatus=__bind(this.checkStatus,this),this.checkCurrency=__bind(this.checkCurrency,this),this.cart={items:[]},o=localStorage.getItem("imagoCart"),o&&this.checkStatus(o),this.checkCurrency()}return t.prototype.checkCurrency=function(){var t;return t=[],t.push(this.$http.get("//www.telize.com/geoip",{headers:{NexClient:void 0,NexTenant:void 0}}).then(function(t){return function(i){return t.telize=i.data}}(this))),t.push(this.$http.get(""+this.imagoSettings.host+"/api/settings").then(function(t){return function(i){var s;return s=_.find(i.data,{name:"currencies"}),t.currencies=s.value}}(this))),this.$q.all(t).then(function(t){return function(){var i;return i=t.imagoUtils.CURRENCY_MAPPING[t.telize.country],__indexOf.call(t.currencies,i)>=0?t.currency=i:t.currencies.length?t.currency=t.currencies[0]:console.log("you need to enable at least one currency in the settings"),t.currency?t.cart.currency=t.currency:void 0}}(this))},t.prototype.checkStatus=function(t){return this.$http.get(""+this.imagoSettings.host+"/api/carts?cartid="+t).then(function(t){return function(i){return console.log("check status",i),_.assign(t.cart,i.data)}}(this))},t.prototype.checkCart=function(){var t;return t=this.$q.defer(),this.cart._id?t.resolve("update"):this.create(this.cart).then(function(i){return function(s){return _.assign(i.cart,s.data),localStorage.setItem("imagoCart",s.data._id),t.resolve("created")}}(this)),t.promise},t.prototype.create=function(t){return this.$http.post(""+this.imagoSettings.host+"/api/carts",t)},t.prototype.add=function(t){var i,s,e;return t.qty?(t.serving_url||(e=this.imagoModel.find({_id:t.parent}),e&&(t.serving_url=e.serving_url)),i=angular.copy(t),s=_.find(this.cart.items,{_id:i._id}),s?s.qty+=i.qty:this.cart.items.push(i),this.checkCart().then(function(t){return function(i){return"update"===i?t.update():void 0}}(this))):console.log("quantity required")},t.prototype.update=function(){return this.cart._id?this.$http.put(""+this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart):void 0},t.prototype.remove=function(t){var i;return i=_.findIndex(this.cart.items,{_id:t._id}),this.cart.items.splice(i,1),this.update()},t.prototype.checkout=function(){return tenant?this.$window.location.href="https://"+tenant+".2.imagoapp.com/account/checkout/"+this.cart._id:void 0},t}(),angular.module("imago").service("imagoCart",["$q","$window","$http","imagoUtils","imagoModel","imagoSettings",imagoCart]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-cart.html",'<div class="cart"><div class="items"><div ng-repeat="item in cart.utils.cart.items" class="item"><b>{{ item._id }}</b><div ng-model="item.qty"></div><button ng-click="cart.utils.remove(item)">remove</button></div></div><button type="submit" ng-click="cart.utils.checkout()" ng-disabled="!cart.utils.cart.items.length" class="checkout">checkout</button></div>')}]);
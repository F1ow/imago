var ImagoVirtualList;ImagoVirtualList=function(){function t(t,i,e){return{scope:!0,templateUrl:"/imago/imago-virtual-list.html",transclude:!0,controller:function(){},controllerAs:"imagovirtuallist",bindToController:{data:"=",onBottom:"&"},link:function(r,o,l,n,a){var s,u;return a(r,function(t){return o.children().append(t)}),s={},s.scrollTop=0,s.scrollBottomTrigger=500,r.init=function(){return r.imagovirtuallist.data?(r.resetSize(),e(function(){var i,e;return e=document.createElement("div"),e.className=l.classItem,e.id="virtual-list-test-div",o.append(e),s.rowWidth=e.clientWidth,s.rowHeight=e.clientHeight,angular.element(o[0].querySelector("#virtual-list-test-div")).remove(),s.width=o[0].clientWidth,s.height=o[0].clientHeight,l.imagoVirtualListContainer?o[0].addEventListener("scroll",r.onScrollContainer):angular.element(t).on("scroll",r.onScrollWindow),s.triggerHeight=s.rowHeight+s.scrollBottomTrigger,s.itemsPerRow=Math.floor(s.width/s.rowWidth),s.canvasHeight=Math.ceil(r.imagovirtuallist.data.length/s.itemsPerRow)*s.rowHeight,r.canvasStyle={height:s.canvasHeight+"px"},i=Math.round(s.height/s.rowHeight),s.cellsPerPage=i*s.itemsPerRow,s.numberOfCells=i===Math.ceil(s.height/s.rowHeight)?3*s.cellsPerPage:4*s.cellsPerPage,s.margin=Math.round(s.width/s.itemsPerRow-s.rowWidth),1===s.itemsPerRow&&(s.margin=s.margin/2),r.updateDisplayList()})):void 0},r.updateDisplayList=function(){var t,i,e,o,l,n,a,u,c;for(l=Math.max(Math.floor(s.scrollTop/s.rowHeight)-Math.round(s.height/s.rowHeight),0),t=Math.min(l+s.numberOfCells,s.numberOfCells),e=l*s.itemsPerRow,r.visibleProvider=r.imagovirtuallist.data.slice(e,e+t),i=_.chunk(r.visibleProvider,s.itemsPerRow),n=0,u=r.visibleProvider.length,c=[];u>n;)o=function(){var t,e,o,l,a,s,u,c,g;for(o=s=0,c=i.length;c>s;o=++s)for(t=i[o],l=u=0,g=t.length;g>u;l=++u)if(a=t[l],a._id===r.visibleProvider[n]._id)return e={chunk:o,inside:l}},a=o(),r.visibleProvider[n].styles={transform:"translate("+(s.rowWidth*a.inside+s.margin+"px")+", "+((l+a.chunk)*s.rowHeight+"px")+")"},c.push(n++);return c},r.onScrollContainer=function(){return s.scrollTop=o.prop("scrollTop"),r.updateDisplayList(),r.$digest()},r.onScrollWindow=function(){return s.scrollTop=t.pageYOffset,s.canvasHeight-s.scrollTop<=s.triggerHeight&&r.imagovirtuallist.onBottom(),r.updateDisplayList(),r.$digest()},r.resetSize=function(){return r.visibleProvider=[],r.canvasStyle={},s.cellsPerPage=0,s.numberOfCells=0,s.width=0,s.height=0},r.$watch("imagovirtuallist.data",function(){return r.init()}),u=[],u.push(i.$on("imagovirtuallist:init",function(){return r.init()})),u.push(i.$on("resizestop",function(){return r.init()})),r.$on("$destroy",function(){var i,e,o,l;for(angular.element(t).off("scroll",r.onScrollWindow),o=[],i=0,e=u.length;e>i;i++)l=u[i],o.push(l());return o})}}}return t}(),angular.module("imago").directive("imagoVirtualList",["$window","$rootScope","$timeout",ImagoVirtualList]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/imago-virtual-list.html",'<div ng-style="canvasStyle" class="canvas"></div>')}]);
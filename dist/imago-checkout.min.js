var Calculation,__bind=function(t,s){return function(){return t.apply(s,arguments)}},__indexOf=[].indexOf||function(t){for(var s=0,i=this.length;i>s;s++)if(s in this&&this[s]===t)return s;return-1};Calculation=function(){function t(t,s,i,e,n,r){this.$q=t,this.$state=s,this.$http=i,this.$auth=e,this.imagoUtils=n,this.imagoSettings=r,this.submit=__bind(this.submit,this),this.calculate=__bind(this.calculate,this),this.calculateTotal=__bind(this.calculateTotal,this),this.getZipTax=__bind(this.getZipTax,this),this.getTaxRate=__bind(this.getTaxRate,this),this.calculateShipping=__bind(this.calculateShipping,this),this.changeShipping=__bind(this.changeShipping,this),this.findShippingRate=__bind(this.findShippingRate,this),this.getShippingRate=__bind(this.getShippingRate,this),this.setShippingRates=__bind(this.setShippingRates,this),this.setCurrency=__bind(this.setCurrency,this),this.applyCoupon=__bind(this.applyCoupon,this),this.checkCoupon=__bind(this.checkCoupon,this),this.changeAddress=__bind(this.changeAddress,this),this.deleteItem=__bind(this.deleteItem,this),this.updateCart=__bind(this.updateCart,this),this.countries=this.imagoUtils.COUNTRIES}return t.prototype.cart=void 0,t.prototype.stripe=void 0,t.prototype.currency=void 0,t.prototype.shippingmethods=void 0,t.prototype.taxes=void 0,t.prototype.currencies=void 0,t.prototype.taxincluded=void 0,t.prototype.error={},t.prototype.updateCart=function(){return this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},t.prototype.deleteItem=function(t){var s;return s=_.findIndex(this.cart.items,{id:t.id}),this.cart.items.splice(s,1),this.updateCart()},t.prototype.changeAddress=function(t,s){var i,e,n,r;return(null!=(i=this.process.form.shipping_address)?i.country:void 0)&&"country"===s?this.setCurrency(null,this.process.form.shipping_address.country):"country"===s&&this.setCurrency(null,this.process.form[t].country),this[t]||(this[t]={}),"United States of America"===(e=this.process.form[t].country)||"United States"===e||"USA"===e||"Canada"===e||"Australia"===e?(this[t].disablestates=!1,this[t].states="United States of America"===(n=this.process.form[t].country)||"United States"===n||"USA"===n?this.imagoUtils.STATES.USA:this.imagoUtils.STATES[this.process.form[t].country.toUpperCase()]):(this[t].disablestates=!0,this[t].states=[]),this.process.form[t].country_code=this.imagoUtils.CODES[this.process.form[t].country],(null!=(r=this.process.form.shipping_address)?r.country:void 0)?(this.country=this.process.form.shipping_address.country,this.state=this.process.form.shipping_address.state,this.zip=this.process.form.shipping_address.zip):(this.country=this.process.form[t].country,this.state=this.process.form[t].state,this.zip=this.process.form[t].zip),this.calculate()},t.prototype.checkCoupon=function(t){return t?this.$http.get(this.imagoSettings.host+"/api/coupons?code="+t).then(function(t){return function(s){return 1===s.data.length?(t.coupon=s.data[0],t.couponState="valid",t.calculate()):t.couponState="invalid"}}(this)):(this.couponState="",void this.calculate())},t.prototype.applyCoupon=function(t,s){var i,e,n;if(t)return i=t.meta,"flat"===i.type?(n=Math.min(s.subtotal,i.value[this.currency]),s.subtotal=s.subtotal-n):"percent"===i.type?(e=Number((s.subtotal*i.value/1e4).toFixed(0)),s.subtotal=s.subtotal-e):"free shipping"===i.type?s.shipping=0:void 0},t.prototype.setCurrency=function(t,s){return s&&(t=this.imagoUtils.inUsa(s)?"USD":this.imagoUtils.CURRENCY_MAPPING[s]),this.currency=__indexOf.call(this.currencies,t)>=0?t:this.currencies[0]},t.prototype.setShippingRates=function(t){return(null!=t?t.length:void 0)?_.isPlainObject(t)?this.shippingRates=[t]:_.isArray(t)&&(this.shippingRates=t):this.shippingRates=[],this.shippingRates.length?this.shipping_options=this.shippingRates[0]:void 0},t.prototype.getShippingRate=function(){var t,s;return t=this.$q.defer(),s=this.findShippingRate(),this.setShippingRates(s),t.resolve(s),t.promise},t.prototype.findShippingRate=function(){var t,s,i;if(this.country)return("United States of America"===(i=this.country)||"USA"===i)&&(this.country="United States"),s=_.filter(this.shippingmethods,function(t){return function(s){var i,e,n;return s.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,__indexOf.call(function(){var t,e,n,r;for(n=s.countries,r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.filter(s,function(t){return function(s){var i,e;return e=t.state.toUpperCase(),__indexOf.call(function(){var t,e,n,r;for(n=s.states,r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.toUpperCase());return r}(),e)>=0}}(this)),(null!=t?t.length:void 0)?t:t=_.filter(s,function(){return function(t){return 0===t.states.length}}(this))||_.filter(this.shippingmethods,function(t){return!t.countries.length})):s||_.filter(this.shippingmethods,function(t){return!t.countries.length})},t.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options,this.$q.defer()),this.calculateTotal()},t.prototype.calculateShipping=function(){var t;return t=this.$q.defer(),this.costs.shipping=0,this.getShippingRate().then(function(s){return function(i){return(null!=i?i.length:void 0)?(s.error.noshippingrule=!1,s.calcShipping(i[0],t)):(s.country&&(s.error.noshippingrule=!0),t.resolve())}}(this)),t.promise},t.prototype.calcShipping=function(t,s){var i,e,n,r,o,a,c,h,p,u,l,d;for(i=0,r=[],p=this.cart.items,o=0,c=p.length;c>o;o++)e=p[o],(null!=(u=e.shipping_cost)?u[this.currency]:void 0)?(null!=(l=e.shipping_cost)?l[this.currency]:void 0)&&r.push(e):i+="weight"===t.type?e.weight*e.qty:e.qty;if(0===i&&"weight"!==t.type&&!r.length)return s.resolve();for(n=_.find(t.ranges,function(t){return i<=t.to_unit&&i>=t.from_unit}),n||(n=t.ranges[t.ranges.length-1]||0),this.costs.shipping="weight"===t.type?n.price[this.currency]||0:(n.price[this.currency]||0)*i,a=0,h=r.length;h>a;a++)e=r[a],this.costs.shipping+=((null!=(d=e.shipping_cost)?d[this.currency]:void 0)||0)*e.qty;return s.resolve()},t.prototype.calculateTax=function(){var t;return t=this.$q.defer(),this.getTaxRate().then(function(s){return function(){var i,e,n,r,o,a,c,h;if(s.costs.tax=0,s.taxincluded)return void t.resolve();if(s.imagoUtils.includesTax(s.currency)){if(s.costs.includedTax=0,s.costs.taxRate){for(c=s.cart.items,n=0,o=c.length;o>n;n++)i=c[n],e=i.fields.price.value[s.currency]/(100+s.costs.taxRate)*i.qty,s.costs.includedTax+=100*Math.round(e*s.costs.taxRate);return t.resolve()}return t.resolve()}for(h=s.cart.items,r=0,a=h.length;a>r;r++)i=h[r],i.fields.price.value[s.currency]&&(s.costs.tax+=Math.round(i.fields.price.value[s.currency]*i.qty*s.costs.taxRate));return t.resolve()}}(this)),t.promise},t.prototype.getTaxRate=function(){var t,s;return t=this.$q.defer(),this.costs.taxRate=0,this.taxincluded&&t.resolve(),this.country||t.resolve(),s=this.findTaxRate(),s.autotax&&this.imagoUtils.inUsa(this.country)?this.getZipTax():(this.costs.taxRate=s.rate/100,t.resolve(),t.promise)},t.prototype.findTaxRate=function(){var t,s,i,e;return("United States of America"===(e=this.country)||"USA"===e)&&(this.country="United States"),i=_.filter(this.taxes,function(t){return function(s){var i,e,n;return s.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,__indexOf.call(function(){var t,e,n,r;for(n=s.countries,r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.find(i,function(t){return function(s){var i,e;return e=t.state.toUpperCase(),__indexOf.call(function(){var t,e,n,r;for(n=s.states,r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.toUpperCase());return r}(),e)>=0}}(this)))?t:(s=_.filter(i,function(t){return 0===t.states.length}),(null!=s?s[0]:void 0)||{rate:0}):(null!=i?i[0]:void 0)||{rate:0}},t.prototype.getZipTax=function(){var t,s;return t=this.$q.defer(),this.zip||(null!=(s=this.zip)?s.length:void 0)>4?this.$http.get(""+this.imagoSettings.host+"/api/ziptax?zipcode="+this.zip).then(function(s){return function(i){return s.costs.taxRate=i.data.taxUse,t.resolve()}}(this)):t.resolve(),t.promise},t.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&!this.taxincluded&&(this.costs.total+=this.costs.tax),this.costs.total},t.prototype.calculate=function(){var t,s,i,e;for(this.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},e=this.cart.items,s=0,i=e.length;i>s;s++)t=e[s],t.fields.price.value[this.currency]&&t.qty&&(this.costs.subtotal+=t.qty*t.fields.price.value[this.currency]);return this.costs.total=this.costs.subtotal,this.coupon&&this.applyCoupon(this.coupon,this.costs),this.$q.all([this.calculateTax(),this.calculateShipping()]).then(function(t){return function(){return t.calculateTotal()}}(this))},t.prototype.submit=function(){return this.processing?void 0:(this.processing=!0,this.process.form.items=angular.copy(this.cart.items),this.process.form.costs=angular.copy(this.costs),this.process.form.currency=angular.copy(this.currency),this.process.form.billing_address.name=angular.copy(this.process.form.card.name),this.process.form.costs.shipping_options=angular.copy(this.shipping_options),this.process.form.costs.coupon=angular.copy(this.coupon),this.process.form.cartId=angular.copy(this.cart._id),this.differentshipping||(this.process.form.shipping_address=angular.copy(this.process.form.billing_address)),this.$http.post(this.imagoSettings.host+"/api/checkout",this.process.form).then(function(t){return function(s){var i,e,n,r;if(t.$auth.setToken(s.data.token),200===s.data.code)for(r=s.data.result,e=0,n=r.length;n>e;e++){i=r[e],t.$state.go("order",{number:i.number});break}return t.processing=!1}}(this)))},t}(),angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoSettings",Calculation]);var Costs;Costs=function(){function t(){return{scope:{costs:"=",currency:"="},controllerAs:"costs",templateUrl:"/imago/costs.html"}}return t}(),angular.module("imago").directive("costs",[Costs]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/costs.html",'<table><tbody><tr><td>subtotal</td><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.subtotal | price }}</td></tr><tr><td>shipping</td><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.shipping | price }}</td></tr><tr ng-show="costs.includedTax"><td>included tax</td><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.includedTax | price }}</td></tr><tr ng-show="!costs.includedTax"><td>tax</td><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.tax | price }}</td></tr><tr class="total"><td>total</td><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.total | price }}</td></tr></tbody></table>')}]);
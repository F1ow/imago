var Calculation,bind=function(t,i){return function(){return t.apply(i,arguments)}},indexOf=[].indexOf||function(t){for(var i=0,s=this.length;s>i;i++)if(i in this&&this[i]===t)return i;return-1};Calculation=function(){function t(t,i,s,e,n,r){this.$q=t,this.$state=i,this.$http=s,this.$auth=e,this.imagoUtils=n,this.imagoSettings=r,this.submit=bind(this.submit,this),this.calculate=bind(this.calculate,this),this.calculateTotal=bind(this.calculateTotal,this),this.getZipTax=bind(this.getZipTax,this),this.getTaxRate=bind(this.getTaxRate,this),this.calculateShipping=bind(this.calculateShipping,this),this.changeShipping=bind(this.changeShipping,this),this.findShippingRate=bind(this.findShippingRate,this),this.getShippingRate=bind(this.getShippingRate,this),this.setShippingRates=bind(this.setShippingRates,this),this.setCurrency=bind(this.setCurrency,this),this.applyCoupon=bind(this.applyCoupon,this),this.checkCoupon=bind(this.checkCoupon,this),this.changeAddress=bind(this.changeAddress,this),this.deleteItem=bind(this.deleteItem,this),this.updateCart=bind(this.updateCart,this),this.countries=this.imagoUtils.COUNTRIES}return t.prototype.cart=void 0,t.prototype.stripe=void 0,t.prototype.currency=void 0,t.prototype.shippingmethods=void 0,t.prototype.taxes=void 0,t.prototype.currencies=void 0,t.prototype.taxincluded=void 0,t.prototype.updateCart=function(){return this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},t.prototype.deleteItem=function(t){var i;return i=_.findIndex(this.cart.items,{id:t.id}),this.cart.items.splice(i,1),this.updateCart()},t.prototype.changeAddress=function(t,i){var s,e,n,r;return(null!=(s=this.process.form.shipping_address)?s.country:void 0)&&"country"===i?this.setCurrency(null,this.process.form.shipping_address.country):"country"===i&&this.setCurrency(null,this.process.form[t].country),this[t]||(this[t]={}),"United States of America"===(e=this.process.form[t].country)||"United States"===e||"USA"===e||"Canada"===e||"Australia"===e?(this[t].disablestates=!1,this[t].states="United States of America"===(n=this.process.form[t].country)||"United States"===n?this.imagoUtils.STATES.USA:this.imagoUtils.STATES[this.process.form[t].country.toUpperCase()]):(this[t].disablestates=!0,this[t].states=[]),this.process.form[t].country_code=this.imagoUtils.CODES[this.process.form[t].country],(null!=(r=this.process.form.shipping_address)?r.country:void 0)?(this.country=this.process.form.shipping_address.country,this.state=this.process.form.shipping_address.state,this.zip=this.process.form.shipping_address.zip):(this.country=this.process.form[t].country,this.state=this.process.form[t].state,this.zip=this.process.form[t].zip),this.calculate()},t.prototype.checkCoupon=function(t){return t?this.$http.get(this.imagoSettings.host+"/api/coupons?code="+t).then(function(t){return function(i){return 1===i.data.length?(t.coupon=i.data[0],t.couponState="valid",t.calculate()):t.couponState="invalid"}}(this)):(this.couponState="",void this.calculate())},t.prototype.applyCoupon=function(t,i){var s,e,n;if(t)return s=t.meta,"flat"===s.type?(n=Math.min(i.subtotal,s.value[this.currency]),i.subtotal=i.subtotal-n):"percent"===s.type?(e=Number((i.subtotal*s.value/1e4).toFixed(0)),i.subtotal=i.subtotal-e):"free shipping"===s.type?i.shipping=0:void 0},t.prototype.setCurrency=function(t,i){return i&&(t=this.imagoUtils.inUsa(i)?"USD":this.imagoUtils.CURRENCY_MAPPING[i]),this.currency=indexOf.call(this.currencies,t)>=0?t:this.currencies[0]},t.prototype.setShippingRates=function(t){return(null!=t?t.length:void 0)?_.isPlainObject(t)?this.shippingRates=[t]:_.isArray(t)&&(this.shippingRates=t):this.shippingRates=[],this.shippingRates.length?this.shipping_options=this.shippingRates[0]:void 0},t.prototype.getShippingRate=function(){var t,i;return t=this.$q.defer(),i=this.findShippingRate(),this.setShippingRates(i),t.resolve(i),t.promise},t.prototype.findShippingRate=function(){var t,i,s;if(this.country)return("United States of America"===(s=this.country)||"United States"===s)&&(this.country="USA"),i=_.filter(this.shippingmethods,function(t){return function(i){var s,e,n;return i.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,indexOf.call(function(){var t,e,n,r;for(n=i.countries,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.filter(i,function(t){return function(i){var s,e;return s=t.state.toUpperCase(),indexOf.call(function(){var t,s,n,r;for(n=i.states,r=[],t=0,s=n.length;s>t;t++)e=n[t],r.push(e.toUpperCase());return r}(),s)>=0}}(this)),(null!=t?t.length:void 0)?t:t=_.filter(i,function(){return function(t){return 0===t.states.length}}(this))||_.filter(this.shippingmethods,function(t){return!t.countries.length})):i||_.filter(this.shippingmethods,function(t){return!t.countries.length})},t.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options,this.$q.defer()),this.calculateTotal()},t.prototype.calculateShipping=function(){var t;return t=this.$q.defer(),this.costs.shipping=0,this.getShippingRate().then(function(i){return function(s){return(null!=s?s.length:void 0)?(i.calcShipping(s[0],t),t.promise):t.resolve()}}(this))},t.prototype.calcShipping=function(t,i){var s,e,n,r,o,a,c,h,p,u,l,d;for(s=0,d=[],h=this.cart.items,e=0,o=h.length;o>e;e++)n=h[e],(null!=(p=n.shipping_cost)?p[this.currency]:void 0)?(null!=(u=n.shipping_cost)?u[this.currency]:void 0)&&d.push(n):s+="weight"===t.type?n.weight*n.qty:n.qty;if(0===s&&"weight"!==t.type&&!d.length)return i.resolve();for(c=_.find(t.ranges,function(t){return s<=t.to_unit&&s>=t.from_unit}),c||(c=t.ranges[t.ranges.length-1]||0),this.costs.shipping="weight"===t.type?c.price[this.currency]||0:(c.price[this.currency]||0)*s,r=0,a=d.length;a>r;r++)n=d[r],this.costs.shipping+=((null!=(l=n.shipping_cost)?l[this.currency]:void 0)||0)*n.qty;return i.resolve()},t.prototype.calculateTax=function(){var t;return t=this.$q.defer(),this.getTaxRate().then(function(i){return function(){var s,e,n,r,o,a,c,h,p;if(i.costs.tax=0,i.taxincluded)return void t.resolve();if(i.imagoUtils.includesTax(i.currency)){if(i.costs.includedTax=0,i.costs.taxRate){for(c=i.cart.items,p=[],s=0,r=c.length;r>s;s++)e=c[s],a=e.fields.price.value[i.currency]/(100+i.costs.taxRate)*e.qty,i.costs.includedTax+=Math.round(a*i.costs.taxRate),p.push(t.resolve());return p}return t.resolve()}for(h=i.cart.items,n=0,o=h.length;o>n;n++)e=h[n],i.costs.tax+=Math.round(e.fields.price.value[i.currency]*e.qty*i.costs.taxRate);return t.resolve()}}(this)),t.promise},t.prototype.getTaxRate=function(){var t,i;return t=this.$q.defer(),this.costs.taxRate=0,this.taxincluded&&t.resolve(),this.country||t.resolve(),i=this.findTaxRate(),i.autotax&&this.imagoUtils.inUsa(this.country)?this.getZipTax():(this.costs.taxRate=i.rate/100,t.resolve(),t.promise)},t.prototype.findTaxRate=function(){var t,i,s,e;return("United States of America"===(e=this.country)||"United States"===e)&&(this.country="USA"),s=_.filter(this.taxes,function(t){return function(i){var s,e,n;return i.active&&(e=null!=(n=t.country)?n.toUpperCase():void 0,indexOf.call(function(){var t,e,n,r;for(n=i.countries,r=[],t=0,e=n.length;e>t;t++)s=n[t],r.push(s.toUpperCase());return r}(),e)>=0)}}(this)),this.state?(t=_.find(s,function(t){return function(i){var s,e;return s=t.state.toUpperCase(),indexOf.call(function(){var t,s,n,r;for(n=i.states,r=[],t=0,s=n.length;s>t;t++)e=n[t],r.push(e.toUpperCase());return r}(),s)>=0}}(this)))?t:(i=_.filter(s,function(t){return 0===t.states.length}),(null!=i?i[0]:void 0)||{rate:0}):(null!=s?s[0]:void 0)||{rate:0}},t.prototype.getZipTax=function(){var t,i;return t=this.$q.defer(),this.zip||(null!=(i=this.zip)?i.length:void 0)>4?this.$http.get(this.imagoSettings.host+"/api/ziptax?zipcode="+this.zip).then(function(i){return function(s){return i.costs.taxRate=s.data.taxUse,t.resolve()}}(this)):t.resolve(),t.promise},t.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&!this.taxincluded&&(this.costs.total+=this.costs.tax),this.costs.total},t.prototype.calculate=function(){var t,i,s,e;for(this.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},e=this.cart.items,t=0,s=e.length;s>t;t++)i=e[t],this.costs.subtotal+=i.qty*i.fields.price.value[this.currency];return this.costs.total=this.costs.subtotal,this.coupon&&this.applyCoupon(this.coupon,this.costs),this.$q.all([this.calculateTax(),this.calculateShipping()]).then(function(t){return function(){return t.calculateTotal()}}(this))},t.prototype.submit=function(){return this.processing?void 0:(this.processing=!0,this.process.form.items=angular.copy(this.cart.items),this.process.form.costs=angular.copy(this.costs),this.process.form.currency=angular.copy(this.currency),this.process.form.billing_address.name=angular.copy(this.process.form.card.name),this.process.form.costs.shipping_options=angular.copy(this.shipping_options),this.process.form.costs.coupon=angular.copy(this.coupon),this.differentshipping||(this.process.form.shipping_address=angular.copy(this.process.form.billing_address)),this.$http.post(this.imagoSettings.host+"/api/checkout",this.process.form).then(function(t){return function(i){var s,e,n,r;if(console.log("response checkout",i),t.$auth.setToken(i.data.token),200===i.data.code)for(r=i.data.result,s=0,e=r.length;e>s;s++){n=r[s],t.$state.go("order",{number:n.number});break}return t.processing=!1}}(this)))},t}(),angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoSettings",Calculation]);var Costs;Costs=function(){function t(){return{scope:{costs:"=",currency:"="},controllerAs:"costs",templateUrl:"/imago/costs.html"}}return t}(),angular.module("imago").directive("costs",[Costs]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/costs.html",'<table><tbody><tr><td>subtotal</td><td>{{ currency | currencySymbol }} {{ costs.subtotal | price }}</td></tr><tr><td>shipping</td><td>{{ currency | currencySymbol }} {{ costs.shipping | price }}</td></tr><tr ng-show="costs.includedTax"><td>included tax</td><td>{{ currency | currencySymbol }} {{ costs.includedTax | price }}</td></tr><tr ng-show="!costs.includedTax"><td>tax</td><td>{{ currency | currencySymbol }} {{ costs.tax | price }}</td></tr><tr class="total"><td>total</td><td>{{ currency | currencySymbol }} {{ costs.total | price }}</td></tr></tbody></table>')}]);